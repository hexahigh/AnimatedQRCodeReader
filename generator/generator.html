<!DOCTYPE html>
<html>

<head>
<script type="text/javascript" src="qrcode.js"></script>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
</head>
<body>

<input type="file" id="file" onchange="loadfile()"/>
<input type="checkbox" id="loopChk" value="Loop" checked>
<label for="loopChk">Loop</label>
</br>
<label for="name">Chunk size (bytes):</label>

<input type="text" id="chunkSize" name="chunkSize" value="2500">
<label for="name">Extra interval (ms):</label>

<input type="text" id="interval" name="interval" value="500">
</br>
<input type="button" value="Stop" onclick="stop();" />
<input type="button" value="Start" onclick="start();" />
<div id="progress"></div>
<div id="placeHolder"></div>

<script>
var chunks = [];
var currentIndex = 0;
var stopLoop = false;
var maxWidth = 0;
var maxHeight = 0;
function createQRCode(data){
    var typeNumber = 0;
    var errorCorrectionLevel = 'L';
    var qr = qrcode(typeNumber, errorCorrectionLevel);
    qr.addData(data);
    qr.make();
    var placeHolder = document.getElementById('placeHolder');
    placeHolder.innerHTML = qr.createSvgTag(); // or createImgTag
    var img = placeHolder.children[0];
    var width = img.getAttribute("width").replace("px","");
    var height = img.getAttribute("height").replace("px","");
    maxWidth = Math.max(maxWidth,width);
    maxHeight = Math.max(maxHeight,height);
    if (width<maxWidth){
        img.setAttribute("width",maxWidth);
    }
    if (height<maxHeight){
        img.setAttribute("height",maxHeight);
    }    
}

function stop(){
    stopLoop=true;
}

function start(){
    showAnimatedQRCode();
}

function loadfile() { 
    let files = document.getElementById('file').files;
    if (files.length == 0) {
        return;
    }
    var file = files[0];
    fileReader = new FileReader();
    fileReader.onload = function(e){
        stop();
        currentIndex=0;
        maxWidth=0;
        maxHeight=0;
        loadBase64ToChunks(e.target.result,file.name);
        stopLoop=false;
        showAnimatedQRCode();
    };
    fileReader.onerror = function () {
        console.warn('oops, something went wrong.');
    };
    fileReader.readAsDataURL(file);
}

function loadBase64ToChunks(base64,filename){
    var data = filename+","+base64;
    var chunkSize = parseInt(document.getElementById("chunkSize").value);
    console.log("chunk size:"+chunkSize);
    var num = Math.ceil(data.length / chunkSize)
    chunks=[];
    for (var i=0;i<num;i++){
        var start = i*chunkSize;
        var chunk = data.slice(start,start+chunkSize);
        chunk = (i+1)+"/"+num+","+chunk;
        chunks.push(chunk);
    }
    console.log(chunks);
}

function showAnimatedQRCode(){
    createQRCode(chunks[currentIndex]);
    currentIndex = currentIndex + 1
    document.getElementById("progress").innerHTML = currentIndex + "/" + chunks.length;
    if (currentIndex == chunks.length){
        currentIndex = 0;
        if (document.getElementById("loopChk").checked==false){
            return;
        }
    }
    if (stopLoop){
        stopLoop=false;
        return;
    }
    var interval = parseInt(document.getElementById("interval").value)
    console.log("interval:"+interval);
    setTimeout("showAnimatedQRCode()",interval);
}

</script>
</body>
</html>