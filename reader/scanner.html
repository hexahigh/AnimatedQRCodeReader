<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
<style>

.statisticsContainer{
    position:absolute;
    left:50%;
    bottom:0;
    transform:translate(-50%,0);
    text-align: center;
    color: white;
    text-shadow: 1px 1px black;
}

.statisticsContainerScanned{

}


</style>
</head>
<body>
    <div id="scanner">
        <video class="dbrScanner-video" playsinline="true" style="width:100%;height:100%;position:absolute;left:0;top:0;"></video>
        <canvas class="dbrScanner-cvs-drawarea" style="width:100%;height:100%;position:absolute;left:0;top:0;"></canvas>
        <div class="dbrScanner-cvs-scanarea" style="width:100%;height:100%;position:absolute;left:0;top:0;">
            <div class="dbrScanner-scanlight" style="width:100%;height:3%;position:absolute;animation:3s infinite dbrScanner-scanlight;border-radius:50%;box-shadow:0px 0px 2vw 1px #00e5ff;background:#fff;display:none;"></div>
        </div>
        <select class="dbrScanner-sel-camera" style="margin:0 auto;position:absolute;left:0;top:0;height:30px;"></select>
        <select class="dbrScanner-sel-resolution" style="position:absolute;left:0;top:30px;"></select>
    </div>
    <div class="statisticsContainer">
        <pre id="statistics">
        </pre>
    </div>
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@8.6.1/dist/dbr.js"></script>
  <script>
    // initializes and uses the library
    var startTime = 0;
    var framesRead = 0;
    var successNum =0;
    var code_results = {};
    var total = 0;
    let pScanner = null;
    Dynamsoft.DBR.BarcodeScanner.organizationID = "100180174";
    (async () => {
        scanner = await (pScanner = pScanner || Dynamsoft.DBR.BarcodeScanner.createInstance());
        await scanner.setUIElement(document.getElementById('scanner'));
        scanner.onFrameRead = results => {
            
            framesRead = framesRead + 1;
            if (results.length > 0) {
                successNum = successNum + 1;
            };
            updateStatistics();
        };
        scanner.onUnduplicatedRead = (txt, result) => {
            processUnduplicatedRead(result);
        };
        await scanner.show();
        updateSettings();
        startTime = new Date().getTime();
    })();
    
    

    
    function updateStatistics(){
        var statisticsContainer = document.getElementById("statistics");
        var endTime = new Date().getTime();
        statistics = "elapsed time: " + (endTime-startTime)/1000 +"s";
        statistics = statistics +"\ntotal frame number: " + framesRead;
        statistics = statistics +"\nsuccessful number: " + successNum;
        statistics = statistics +"\ndecoding rate: " + (successNum/framesRead).toFixed(2);
        statistics = statistics +"\nprogress: " + getObjectLength(code_results) + "/" + total;
        statisticsContainer.innerHTML=statistics;
    }
    
    
    function processUnduplicatedRead(result){
        var text = result["barcodeText"];
        try {
            var meta = text.split(",")[0];
            var totalOfThisOne = parseInt(meta.split("/")[1]);
            if (total != totalOfThisOne && total!=0){
                total = totalOfThisOne;
                code_results={};
                return;
            }
            total = totalOfThisOne;
            var index = parseInt(meta.split("/")[0]);
            code_results[index]=text;
            if (getObjectLength(code_results)==total){
                console.log("completed");
                console.log(code_results);
                stop();
                updateStatistics();
                showResult();
            }
        
        } catch(error) {
            console.log(error);
        }
    }
    
    function getObjectLength(obj){
        return getObjectKeys(obj).length;
    }
    
    function getObjectKeys(obj){
        return Object.keys(obj);
    }
    
    function stop(){
        scanner.stop()
        var scannerContainer = document.getElementById("scanner");
        scannerContainer.style.display="none";
        var statisticsContainer = document.getElementsByClassName("statisticsContainer")[0];
        statisticsContainer.className="statisticsContainerScanned";
    }
    
    function showResult(){
        var jointData = "";
        for (var i=0;i<getObjectLength(code_results);i++){
            var index = i+1;
            var result = code_results[index];
            if (index == 1){
                meta = result.split(",")[1]; //the first one contains data:image/jpeg;base64,
                data = result.split(",")[2];
            }else{
                data = result.split(",")[1];
            }
            jointData = jointData + data;
        }
        var dataURL = meta +","+ jointData;
        appendDownloadLink(dataURL);
        if (meta.indexOf("image")!=-1) {
            var img = document.createElement("img");
            img.src = dataURL;
            img.style.display = "block";
            img.style.maxHeight = "350px";
            img.style.maxWidth = "100%";
            document.body.append(img);
        }
        
    }
    
    function appendDownloadLink(dataURL){
        var link = document.createElement('a');
        link.setAttribute('target', '_blank');
        link.setAttribute('href', dataURL);
        link.setAttribute('download', "file");
        link.innerText="Download";
        document.body.appendChild(link);
    }
    
    async function updateSettings(){
        let settings = await scanner.getRuntimeSettings();
        settings.deblurLevel = 0;
        settings.barcodeFormatIds = Dynamsoft.DBR.EnumBarcodeFormat.BF_QR_CODE;
        settings.localizationModes = [Dynamsoft.DBR.EnumLocalizationMode.LM_SCAN_DIRECTLY, 0, 0, 0, 0, 0, 0, 0, 0];
        settings.region.regionMeasuredByPercentage = 1;
        var video = document.getElementsByTagName("video")[0];
        if (video.videoHeight>video.videoWidth){
            settings.region.regionLeft = 0;
            settings.region.regionTop = 25;
            settings.region.regionRight = 100;
            settings.region.regionBottom = 75;
        }else{
            settings.region.regionLeft = 25;
            settings.region.regionTop = 0;
            settings.region.regionRight = 75;
            settings.region.regionBottom = 100;
        }
        await scanner.setModeArgument("BinarizationModes",0,"EnableFillBinaryVacancy","0");
        await scanner.setModeArgument("BinarizationModes",0,"BlockSizeX","71");
        await scanner.setModeArgument("BinarizationModes",0,"BlockSizeY","71");
        await scanner.updateRuntimeSettings(settings);
    }
  </script>
</body>

</html>